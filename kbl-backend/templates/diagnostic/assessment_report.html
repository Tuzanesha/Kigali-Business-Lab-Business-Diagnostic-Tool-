<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Assessment Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --primary:#0a5cc2; --accent:#0ea5e9; --bg:#f5f7fb; --card:#fff; --muted:#6b7280; --ok:#16a34a; --warn:#d97706; --danger:#dc2626;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:var(--bg);margin:0;padding:0}
    .container{max-width:1100px;margin:2rem auto;padding:0 1rem}
    h1{margin:0 0 1rem}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:1rem}
    .card{background:var(--card);border-radius:12px;padding:1rem;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .muted{color:var(--muted)}
    .section{margin-top:1rem}
    .list{display:flex;flex-direction:column;gap:.75rem}
    .pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;font-size:.75rem;font-weight:700}
    .pill.high{background:#fee2e2;color:#991b1b}
    .pill.medium{background:#fef3c7;color:#92400e}
    .pill.low{background:#dcfce7;color:#166534}
    .row{display:flex;align-items:center;justify-content:space-between;gap:1rem}
    .bar{height:10px;border-radius:6px;background:#e5e7eb;position:relative;overflow:hidden}
    .bar > span{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,var(--primary),var(--accent))}
    .toast{position:fixed;right:16px;bottom:16px;display:none;max-width:360px;background:#111;color:#fff;padding:.75rem 1rem;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.2)}
    .toast.show{display:block;animation:fadein .2s ease-out}
    @keyframes fadein{from{opacity:.3;transform:translateY(8px)}to{opacity:1;transform:none}}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}
    .btn{background:var(--primary);color:#fff;border:none;border-radius:8px;padding:.6rem .9rem;cursor:pointer}
    a.btn-link{color:var(--primary);text-decoration:none;font-weight:600}
  </style>
  <script>
    function showToast(msg){
      const t=document.getElementById('toast');
      t.textContent=msg||'';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);
    }
    function qs(name){
      const p=new URLSearchParams(location.search);return p.get(name);
    }
    async function api(path){
      const token=localStorage.getItem('access');
      const res=await fetch(path,{headers:{'Authorization':'Bearer '+(token||''),'Content-Type':'application/json'}});
      if(res.status===401){location.href='/api/web/login/';return null}
      return res.json();
    }
    function pct(n){return Math.max(0,Math.min(100,Math.round(n||0)))}
    function priBadge(priority){
      if(priority>=1 && priority<=2) return '<span class="pill high">HIGH</span>';
      if(priority===3) return '<span class="pill medium">MEDIUM</span>';
      return '<span class="pill low">LOW</span>';
    }
    async function load(){
      const id=qs('enterprise_id');
      if(!id){ showToast('Missing enterprise'); return; }
      const data=await api(`/api/enterprise/${id}/report/`);
      if(!data){ return; }
      document.getElementById('ename').textContent=data.name||'Enterprise';
      const overall=pct(data.overall_percentage);
      document.getElementById('overallPct').textContent=overall+'%';
      // radar/ doughnut for overall
      const ctx=document.getElementById('overallChart');
      new Chart(ctx,{type:'doughnut',data:{labels:['Score','Remaining'],datasets:[{data:[overall,100-overall],backgroundColor:['#0ea5e9','#e5e7eb'],borderWidth:0}]},options:{cutout:'65%',plugins:{legend:{display:false}},animation:false}});
      // priority focus areas (from priorities dict keyed by question number)
      const priWrap=document.getElementById('priorityList');
      priWrap.innerHTML='';
      const entries=Object.entries(data.priorities||{});
      const highFirst=entries.sort((a,b)=> (b[1].action_required==='Y')-(a[1].action_required==='Y') || (a[1].priority)-(b[1].priority));
      highFirst.slice(0,6).forEach(([code,item])=>{
        const div=document.createElement('div');
        div.className='card';
        div.innerHTML=`<div class="row"><div><strong>Q${code}</strong> â€” Priority</div><div>${priBadge(item.priority)}</div></div>`;
        priWrap.appendChild(div);
      });
      // category deep dive bars
      const dive=document.getElementById('deepDive');
      dive.innerHTML='';
      const sections=data.section_scores||{};
      Object.keys(sections).forEach(name=>{
        const p=pct(sections[name].percentage);
        const c=document.createElement('div');
        c.className='card';
        c.innerHTML=`<div class="row"><strong>${name}</strong><span class="muted">${p}%</span></div><div class="bar"><span style="width:${p}%"></span></div>`;
        dive.appendChild(c);
      });
    }
    window.addEventListener('load', load);
  </script>
</head>
<body>
  <div class="toast" id="toast"></div>
  <div class="container">
    <h1>Assessment Report</h1>
    <div class="grid">
      <div class="card">
        <div class="header"><h2 id="ename">Enterprise</h2><a class="btn-link" href="/api/web/dashboard/">Back to Dashboard</a></div>
        <div class="row" style="gap:1rem">
          <canvas id="overallChart" width="180" height="180"></canvas>
          <div>
            <div class="muted">Overall Health Score</div>
            <div style="font-size:40px;font-weight:800" id="overallPct">0%</div>
            <div class="muted">This score indicates current overall performance.</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="header"><strong>Performance Overview</strong></div>
        <div class="muted">Quick visual summary of overall score.</div>
        <canvas id="overallChart2" width="1" height="1" style="display:none"></canvas>
      </div>
    </div>

    <div class="section">
      <div class="header"><h3>Priority Focus Areas</h3></div>
      <div id="priorityList" class="list"></div>
    </div>

    <div class="section">
      <div class="header"><h3>Category Deep Dive</h3></div>
      <div id="deepDive" class="list"></div>
    </div>
  </div>
</body>
</html>
