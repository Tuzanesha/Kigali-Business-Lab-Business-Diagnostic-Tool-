<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Set a new password</title>
  <style>body{font-family:sans-serif;max-width:720px;margin:2rem auto}</style>
  <script>
    function getParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name) || '';
    }
    async function setPassword(evt){
      evt.preventDefault();
      const new_password = document.getElementById('new_password').value;
      const uid = getParam('uid');
      const token = getParam('token');
      if(!uid || !token){
        alert('Invalid link. Please request a new reset email.');
        return;
      }
      const res = await fetch('/api/auth/password-reset/confirm/', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({uid, token, new_password})
      });
      const data = await res.json().catch(()=>({}));
      if(res.ok){
        alert('Password changed. You can now log in.');
        location.href = '/api/web/login/';
      } else {
        alert(data.detail || 'Failed to change password');
      }
    }
    window.addEventListener('DOMContentLoaded', () => {
      const uid = getParam('uid');
      const token = getParam('token');
      if(!uid || !token){
        document.getElementById('form').style.display='none';
        document.getElementById('err').style.display='block';
      }
    });
  </script>
</head>
<body>
  <h1>Set a new password</h1>
  <p id="err" style="color:#b00;display:none">Invalid or missing reset token. Please request a new link.</p>
  <form id="form" onsubmit="setPassword(event)">
    <div><label>New password <input id="new_password" type="password" required minlength="8"/></label></div>
    <button type="submit">Change password</button>
  </form>
  <p><a href="/api/web/login/">Back to login</a></p>
</body>
</html>
